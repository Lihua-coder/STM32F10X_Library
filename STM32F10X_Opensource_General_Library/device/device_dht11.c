/*********************************************************************************************************************
* 本文件是STM32F10X 开源库的一部分
* 您可以根据自由软件基金会发布的 GPL（GNU General Public License，即 GNU通用公共许可证）的条款
* 即 GPL 的第3版（即 GPL3.0）或（您选择的）任何后来的版本，重新发布和/或修改它
*
* 本开源库的发布是希望它能发挥作用，但并未对其作任何的保证
* 甚至没有隐含的适销性或适合特定用途的保证
* 更多细节请参见 GPL
* 欢迎各位使用并传播本程序 但修改内容时必须保留版权声明（即本声明）
*
*
* 修改记录
* 日期              作者           备注
* 2026-01-01        Lihua      first version
********************************************************************************************************************/
/*********************************************************************************************************************
* 接线定义：
*                   ------------------------------------
*                   模块管脚            单片机管脚
*                   DAT/OUT           查看 device_dht11.h 中 DHT11_DAT_PIN 宏定义
*                   VCC               3.3V电源
*                   GND               电源地
*                   ------------------------------------
********************************************************************************************************************/
#include "device_dht11.h"

/* 私有宏：总线 IO 快捷操作 */
#define DHT11_LOW()     gpio_set_level(DHT11_DAT_PIN, 0)
#define DHT11_HIGH()    gpio_set_level(DHT11_DAT_PIN, 1)
#define DHT11_READ()    gpio_get_level(DHT11_DAT_PIN)
dht11_data_struct dht11_data;

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     等待电平翻转
// 参数说明     level           电平
// 参数说明     us            	时间
// 返回参数     uint8						超时返回 0 
// 使用示例     dht11_waitlevel(0, 60);
// 备注信息     内部调用
//-------------------------------------------------------------------------------------------------------------------
static uint8 dht11_waitlevel(uint8 level, uint16 us)
{
    while (us--) {
        if (DHT11_READ() == level) return 1;
        system_delay_us(1);
    }
    return 0;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     等待电平翻转
// 参数说明     void            
// 返回参数     uint8						数据
// 使用示例     dht11_readbyte();
// 备注信息     内部调用
//-------------------------------------------------------------------------------------------------------------------
static uint8 dht11_readbyte(void)
{
    uint8 i, data = 0;
    for (i = 0; i < 8; i++) {
        /* 等待 50 us 低电平（数据位开始） */
        if (!dht11_waitlevel(0, 60)) return 0xFF;
        /* 等待高电平，并测量宽度：26~28 us 表示 0，70 us 表示 1 */
        if (!dht11_waitlevel(1, 60)) return 0xFF;
        system_delay_us(35);                /* 35 us 后采样，>35 us 则为 1 */
        data <<= 1;
        if (DHT11_READ() == 1) data |= 1;
        /* 等待高电平结束 */
        dht11_waitlevel(0, 60);
    }
    return data;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     读取一次温湿度
// 参数说明     void            
// 返回参数     uint8						1-失败，0-成功
// 使用示例     dht11_read_tempandhumidity(&dht);
// 备注信息     DHT11_Data_TypeDef dht;
//-------------------------------------------------------------------------------------------------------------------
uint8 dht11_read_tempandhumidity(dht11_data_struct *dht11_data)
{
    uint8 buf[5] = {0};

    /* 1. 主机拉低 ≥18 ms */
    gpio_init(DHT11_DAT_PIN, GPO_PUSH_PULL, 1);
    DHT11_LOW();
    system_delay_ms(20);

    /* 2. 主机释放总线，上拉电阻拉高，等待从机响应 */
    DHT11_HIGH();
    system_delay_us(20);

    /* 3. 切换为输入，等待从机 80 us 低电平响应 */
    gpio_init(DHT11_DAT_PIN, GPI_PULL_UP, 1);
    if (!dht11_waitlevel(0, 90))  goto FAIL;
    if (!dht11_waitlevel(1, 90))  goto FAIL;

    /* 4. 读取 40 bit 数据 */
    for (uint8 i = 0; i < 5; i++) {
        buf[i] = dht11_readbyte();
        if (buf[i] == 0xFF) goto FAIL;
    }

    /* 5. 校验 */
    if (buf[4] != (buf[0] + buf[1] + buf[2] + buf[3])) goto FAIL;

    /* 6. 拷贝到用户结构体 */
    dht11_data->humi_int  = buf[0];
    dht11_data->humi_deci = buf[1];
    dht11_data->temp_int  = buf[2];
    dht11_data->temp_deci = buf[3];

    return 0;   /* 成功 */

FAIL:
    return 1;   /* 失败 */
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     初始化 DHT11
// 参数说明     void
// 返回参数     void          
// 使用示例     dht11_init();
// 备注信息
//-------------------------------------------------------------------------------------------------------------------
void dht11_init(void)
{
    /* 默认上拉输出高电平 */
    gpio_init(DHT11_DAT_PIN, GPO_PUSH_PULL, 1);
}

